name: Build Unminified Plugins

on:
  workflow_dispatch:
  repository_dispatch:
    types: [lnreader-release]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Clone and build TypeScript
        run: |
          git clone --depth 1 https://github.com/LNReader/lnreader-plugins lnreader-source
          cd lnreader-source
          npm ci
          npm run clean:multisrc
          npm run build:multisrc
          npm run build:compile
          npm run build:manifest
      
      - name: Generate build matrix
        id: set-matrix
        run: |
          cd lnreader-source
          
          # Find all plugin directories (language folders)
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          const pluginsDir = '.js/src/plugins';
          const languages = fs.readdirSync(pluginsDir).filter(item => {
            const fullPath = path.join(pluginsDir, item);
            return fs.statSync(fullPath).isDirectory();
          });
          
          console.log(`Found ${languages.length} language directories`);
          
          // Create matrix with language chunks
          const matrix = languages.map(lang => ({ language: lang }));
          
          console.log('Matrix:', JSON.stringify(matrix));
          
          // Output for GitHub Actions
          const output = JSON.stringify(matrix);
          fs.writeFileSync(process.env.GITHUB_OUTPUT || '/dev/stdout', `matrix=${output}\n`, { flag: 'a' });
          SCRIPT
      
      - name: Upload compiled plugins
        uses: actions/upload-artifact@v4
        with:
          name: compiled-plugins
          path: lnreader-source/.js/
          retention-days: 1
      
      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest
          path: lnreader-source/.dist/
          retention-days: 1
  
  bundle:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
      max-parallel: 10
    
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Clone LNReader plugins
        run: |
          git clone --depth 1 https://github.com/LNReader/lnreader-plugins lnreader-source
          cd lnreader-source
          echo "Cloned LNReader plugins repo"
      
      - name: Install dependencies
        run: |
          cd lnreader-source
          npm ci
          # Install esbuild for bundling and Babel for ES5 transpilation
          npm install --save-dev esbuild @babel/core @babel/cli @babel/preset-env
      
      - name: Build plugins (TypeScript compilation)
        run: |
          cd lnreader-source
          npm run clean:multisrc
          npm run build:multisrc
          npm run build:compile
          npm run build:manifest
          
          # Debug: Show what was actually created
          echo "=== Directory structure after build ==="
          ls -la
          echo ""
          echo "=== Looking for .js directories ==="
          find . -type d -name ".js" -o -type d -name "dist" -o -type d -name "build" | head -20
          echo ""
          echo "=== Looking for compiled JS files ==="
          find . -name "*.js" -path "*/plugins/*" | head -20
      
      - name: Check build output structure
        run: |
          cd lnreader-source
          echo "=== Checking build output directories ==="
          echo "Root contents:"
          ls -la | head -20
          echo ""
          echo "Looking for .js directory:"
          if [ -d ".js" ]; then
            echo "Found .js directory"
            ls -la .js/
            if [ -d ".js/src" ]; then
              echo "Found .js/src directory"
              ls -la .js/src/
            fi
            if [ -d ".js/plugins" ]; then
              echo "Found .js/plugins directory"
              ls -la .js/plugins/ | head -10
            fi
          fi
          echo ""
          echo "Looking for src directory:"
          if [ -d "src" ]; then
            ls -la src/ | head -10
          fi
          echo ""
          echo "Looking for plugins directory:"
          if [ -d "plugins" ]; then
            ls -la plugins/ | head -10
          fi
      
      - name: Bundle plugins with dependencies (non-minified)
        run: |
          cd lnreader-source
          
          # Create bundling script
          cat > scripts/bundle-plugins.js << 'EOF'
          import { build } from 'esbuild';
          import fs from 'fs';
          import path from 'path';
          import { fileURLToPath } from 'url';
          
          const __filename = fileURLToPath(import.meta.url);
          const __dirname = path.dirname(__filename);
          
          // Try multiple possible locations for plugins
          const possibleDirs = [
            path.join(__dirname, '../.js/src/plugins'),
            path.join(__dirname, '../.js/plugins'),
            path.join(__dirname, '../src/plugins'),
            path.join(__dirname, '../plugins')
          ];
          
          let pluginsDir = null;
          for (const dir of possibleDirs) {
            if (fs.existsSync(dir)) {
              pluginsDir = dir;
              console.log(`Found plugins directory: ${dir}`);
              break;
            }
          }
          
          if (!pluginsDir) {
            console.error('Plugins directory not found in any of these locations:');
            possibleDirs.forEach(dir => console.error(`  - ${dir}`));
            
            // List what's actually in the project
            console.log('\nActual directory structure:');
            const listDir = (dir, indent = '') => {
              try {
                const items = fs.readdirSync(dir);
                items.slice(0, 10).forEach(item => {
                  const fullPath = path.join(dir, item);
                  const stat = fs.statSync(fullPath);
                  console.log(`${indent}${item}${stat.isDirectory() ? '/' : ''}`);
                  if (stat.isDirectory() && indent.length < 6) {
                    listDir(fullPath, indent + '  ');
                  }
                });
              } catch (e) {}
            };
            listDir(path.join(__dirname, '..'));
            
            process.exit(1);
          }
          
          const outputDir = path.join(__dirname, '../.bundled/plugins');
          
          async function bundlePlugin(inputFile, outputFile) {
            const config = {
              entryPoints: [inputFile],
              bundle: true,
              format: 'iife',
              platform: 'browser',
              target: 'es2017',
              outfile: outputFile,
              minify: false,
              sourcemap: false,
              treeShaking: false,
              legalComments: 'inline',
              banner: {
                js: '// Bundled plugin with all dependencies included\n// Built for LNReader (ES2017 - will be transpiled to ES5)\n'
              },
              footer: {
                js: '\n// Export for compatibility\nif (typeof module !== "undefined" && module.exports) { module.exports = this; }\n'
              },
              globalName: 'LNReaderPlugin',
              external: [],
              mainFields: ['module', 'main'],
              conditions: ['import', 'require', 'default'],
              logLevel: 'warning'
            };
            
            try {
              await build(config);
              return true;
            } catch (error) {
              console.error(`âŒ Failed to bundle ${path.basename(inputFile)}:`);
              console.error(`   Error: ${error.message}`);
              if (error.errors && error.errors.length > 0) {
                error.errors.slice(0, 3).forEach(err => {
                  console.error(`   ${err.text}`);
                });
              }
              return false;
            }
          }
          
          async function bundleAllPlugins() {
            // Files to skip (build scripts, not actual plugins)
            const skipPatterns = [
              'generator.js',
              'generate-multisrc-plugins.js',
              'get_filters.js',
              'filter_refresh.js',
              'template.js'
            ];
            
            const shouldSkip = (filePath) => {
              const fileName = path.basename(filePath);
              return skipPatterns.some(pattern => fileName === pattern);
            };
            
            // Walk through all plugin files
            const walkDir = (dir, callback) => {
              const files = fs.readdirSync(dir);
              files.forEach(file => {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                if (stat.isDirectory()) {
                  walkDir(filePath, callback);
                } else if (file.endsWith('.js') && !shouldSkip(filePath)) {
                  callback(filePath);
                }
              });
            };
          
            const pluginFiles = [];
            walkDir(pluginsDir, (file) => pluginFiles.push(file));
          
            console.log(`Found ${pluginFiles.length} plugin files to bundle`);
            console.log('Building modern JS version (ES2017)...\n');
          
            let successCount = 0;
            let failCount = 0;
            
            // Bundle each plugin to ES2017 (modern JS)
            for (const inputFile of pluginFiles) {
              const relativePath = path.relative(pluginsDir, inputFile);
              const outputFileModern = path.join(outputDir, relativePath);
              
              // Create output directory
              fs.mkdirSync(path.dirname(outputFileModern), { recursive: true });
              
              // Bundle modern version (ES2017)
              const success = await bundlePlugin(inputFile, outputFileModern);
              
              if (success) {
                successCount++;
                console.log(`âœ… ${relativePath}`);
              } else {
                failCount++;
              }
            }
          
            console.log(`\nâœ… Successfully bundled ${successCount} plugins`);
            if (failCount > 0) {
              console.log(`âš ï¸  Failed to bundle ${failCount} files`);
            }
          }
          
          bundleAllPlugins().catch(console.error);
          EOF
          
          # Run the bundling script (creates ES2017 version)
          node scripts/bundle-plugins.js
          
          echo "âœ… All plugins bundled with dependencies"
      
      - name: Transpile to ES5 using Babel
        run: |
          cd lnreader-source
          
          echo "Transpiling bundled plugins to ES5 using SWC..."
          
          # Create SWC config for ES5 transpilation
          cat > .swcrc << 'EOF'
          {
            "jsc": {
              "parser": {
                "syntax": "ecmascript",
                "dynamicImport": true
              },
              "target": "es5",
              "loose": true,
              "externalHelpers": false,
              "keepClassNames": true,
              "minify": {
                "compress": false,
                "mangle": false
              }
            },
            "module": {
              "type": "es6",
              "strict": false,
              "strictMode": false,
              "lazy": false,
              "noInterop": false
            },
            "minify": false,
            "isModule": false
          }
          EOF
          
          # Transpile entire directory with SWC (very fast)
          echo "Starting SWC transpilation..."
          npx swc .bundled/plugins -d .bundled-es5/plugins --config-file .swcrc --no-swcrc
          
          # Count files
          es5_count=$(find .bundled-es5/plugins -name "*.js" -type f | wc -l)
          echo "Transpiled $es5_count files to ES5"
          
          echo "âœ… ES5 transpilation complete"
      
      - name: Copy built plugins and manifest
        run: |
          mkdir -p plugins-android plugins-desktop
          
          # Copy ES5 transpiled plugins for Android (Rhino compatible)
          if [ -d "lnreader-source/.bundled-es5/plugins" ]; then
            cp -r lnreader-source/.bundled-es5/plugins/* plugins-android/ 2>/dev/null || true
            echo "âœ… Copied ES5 plugins for Android"
          else
            echo "âš ï¸ ES5 plugins not found"
          fi
          
          # Copy modern JS plugins for Desktop (GraalVM compatible)
          if [ -d "lnreader-source/.bundled/plugins" ]; then
            cp -r lnreader-source/.bundled/plugins/* plugins-desktop/ 2>/dev/null || true
            echo "âœ… Copied modern JS plugins for Desktop"
          else
            echo "âš ï¸ Modern JS plugins not found"
          fi
          
          # For backward compatibility, also create a 'plugins' folder with Android version
          mkdir -p plugins
          if [ -d "lnreader-source/.bundled-es5/plugins" ]; then
            cp -r lnreader-source/.bundled-es5/plugins/* plugins/ 2>/dev/null || true
          fi
          
          # Update JSON manifest files with correct URLs using Node.js
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          const updateUrls = (filePath, outputPath, targetDir, minified = false) => {
            if (!fs.existsSync(filePath)) {
              console.log(`âš ï¸  Source file not found: ${filePath}`);
              return;
            }
            
            const content = fs.readFileSync(filePath, 'utf-8');
            const data = JSON.parse(content);
            
            // Update URLs in each plugin entry
            // Only update plugin URLs, keep icons/assets pointing to original repo
            data.forEach(plugin => {
              if (plugin.url) {
                // Replace the entire URL structure
                plugin.url = plugin.url
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/src\/plugins\//g,
                    `https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/master/${targetDir}/`
                  )
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/plugins\//g,
                    `https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/master/${targetDir}/`
                  );
              }
              // Keep iconUrl, customJS, and customCSS pointing to original LNReader repo
              // No changes needed for these fields
            });
            
            // Write JSON - minified or formatted
            const output = minified ? JSON.stringify(data) : JSON.stringify(data, null, '\t');
            fs.writeFileSync(outputPath, output);
            console.log(`âœ… Updated ${path.basename(outputPath)} for ${targetDir}`);
          };
          
          // Create manifests for Android (ES5)
          updateUrls('lnreader-source/.dist/plugins.json', 'plugins-android/plugins.json', 'plugins-android', false);
          updateUrls('lnreader-source/.dist/plugins.min.json', 'plugins-android/plugins.min.json', 'plugins-android', true);
          
          // Create manifests for Desktop (Modern JS)
          updateUrls('lnreader-source/.dist/plugins.json', 'plugins-desktop/plugins.json', 'plugins-desktop', false);
          updateUrls('lnreader-source/.dist/plugins.min.json', 'plugins-desktop/plugins.min.json', 'plugins-desktop', true);
          
          // Create manifests for backward compatibility (points to Android version)
          updateUrls('lnreader-source/.dist/plugins.json', 'plugins/plugins.json', 'plugins-android', false);
          updateUrls('lnreader-source/.dist/plugins.min.json', 'plugins/plugins.min.json', 'plugins-android', true);
          SCRIPT
          
          # Count total plugins
          total=$(find plugins -name "*.js" -type f | wc -l)
          echo "âœ… Copied $total plugin files"
          
          # Show structure
          echo "Plugin structure:"
          ls -lh plugins/ | head -20
      
      - name: Generate plugin lists
        run: |
          # Android README
          echo "# LNReader Plugins - Android (ES5)" > plugins-android/README.md
          echo "" >> plugins-android/README.md
          echo "**ES5 compatible plugins for Android (Rhino JavaScript engine)**" >> plugins-android/README.md
          echo "" >> plugins-android/README.md
          echo "Built from: https://github.com/LNReader/lnreader-plugins" >> plugins-android/README.md
          echo "" >> plugins-android/README.md
          
          total_android=$(find plugins-android -name "*.js" -type f | wc -l)
          echo "**Total: $total_android plugins**" >> plugins-android/README.md
          
          # Desktop README
          echo "# LNReader Plugins - Desktop (Modern JS)" > plugins-desktop/README.md
          echo "" >> plugins-desktop/README.md
          echo "**Modern JavaScript plugins for Desktop (GraalVM)**" >> plugins-desktop/README.md
          echo "" >> plugins-desktop/README.md
          echo "Built from: https://github.com/LNReader/lnreader-plugins" >> plugins-desktop/README.md
          echo "" >> plugins-desktop/README.md
          
          total_desktop=$(find plugins-desktop -name "*.js" -type f | wc -l)
          echo "**Total: $total_desktop plugins**" >> plugins-desktop/README.md
          
          # Main README (backward compatibility)
          echo "# Unminified LNReader Plugins" > plugins/README.md
          echo "" >> plugins/README.md
          echo "Built from: https://github.com/LNReader/lnreader-plugins" >> plugins/README.md
          echo "" >> plugins/README.md
          echo "## Available Versions" >> plugins/README.md
          echo "" >> plugins/README.md
          echo "- **plugins-android/** - ES5 compatible for Android (Rhino)" >> plugins/README.md
          echo "- **plugins-desktop/** - Modern JS for Desktop (GraalVM)" >> plugins/README.md
          echo "" >> plugins/README.md
          
          total=$(find plugins -name "*.js" -type f | wc -l)
          echo "**Total: $total plugins**" >> plugins/README.md
      
      - name: Package plugins by platform
        run: |
          # Package Android plugins (ES5)
          echo "Packaging Android plugins..."
          tar -czf android-plugins-es5.tar.gz plugins-android/
          
          # Package Desktop plugins (Modern JS)
          echo "Packaging Desktop plugins..."
          tar -czf desktop-plugins-modern.tar.gz plugins-desktop/
          
          # Package all plugins together (backward compatibility)
          tar -czf all-plugins.tar.gz plugins/
          
          echo "âœ… Created plugin archives"
          ls -lh *.tar.gz
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add plugins/ plugins-android/ plugins-desktop/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update plugins - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Bundled Plugins v${{ github.run_number }}
          body: |
            # LNReader Plugins - Bundled & Unminified
            
            Built from: https://github.com/LNReader/lnreader-plugins
            Build date: $(date +'%Y-%m-%d %H:%M:%S UTC')
            
            ## ðŸ“¥ Download Options
            
            ### For Android (Rhino JavaScript Engine)
            - **android-plugins-es5.tar.gz** - ES5 compatible plugins for Android
            - All dependencies bundled, transpiled to ES5 for maximum compatibility
            
            ### For Desktop (GraalVM)
            - **desktop-plugins-modern.tar.gz** - Modern JavaScript plugins for Desktop
            - All dependencies bundled, optimized for GraalVM
            
            ### Legacy
            - **all-plugins.tar.gz** - All plugins (Android ES5 version)
            - **plugins.json** - Plugin manifest with metadata
            - **plugins.min.json** - Minified plugin manifest
            
            ## ðŸ“– Usage
            
            ### Android Users
            1. Download `android-plugins-es5.tar.gz`
            2. Extract and copy `.js` files to your LNReader plugins directory
            3. Restart LNReader
            
            ### Desktop Users
            1. Download `desktop-plugins-modern.tar.gz`
            2. Extract and copy `.js` files to your LNReader plugins directory
            3. Restart LNReader
            
            ## âœ¨ Features
            - âœ… All dependencies bundled (cheerio, dayjs, etc.)
            - âœ… Non-minified for easy debugging
            - âœ… ES5 compatible for Android (Rhino)
            - âœ… Modern JS for Desktop (GraalVM)
            - âœ… Self-contained - no external module resolution needed
            
            ## ðŸ“‹ Plugin Manifest
            The JSON files contain metadata for all plugins including:
            - Plugin ID, name, and version
            - Source site URL
            - Language
            - Download URLs
            - Icon URLs
          files: |
            *.tar.gz
            plugins-android/plugins.json
            plugins-android/plugins.min.json
            plugins-desktop/plugins.json
            plugins-desktop/plugins.min.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
