name: Build Unminified Plugins

on:
  workflow_dispatch:
  repository_dispatch:
    types: [lnreader-release]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Clone LNReader plugins
        run: |
          git clone --depth 1 https://github.com/LNReader/lnreader-plugins lnreader-source
          cd lnreader-source
          echo "Cloned LNReader plugins repo"
      
      - name: Install dependencies
        run: |
          cd lnreader-source
          npm ci
          # Install esbuild for bundling and Babel for ES5 transpilation
          npm install --save-dev esbuild @babel/core @babel/cli @babel/preset-env
      
      - name: Build plugins (TypeScript compilation)
        run: |
          cd lnreader-source
          npm run clean:multisrc
          npm run build:multisrc
          npm run build:compile
          npm run build:manifest
      
      - name: Bundle plugins with dependencies (non-minified)
        run: |
          cd lnreader-source
          
          # Create bundling script
          cat > scripts/bundle-plugins.js << 'EOF'
          import { build } from 'esbuild';
          import fs from 'fs';
          import path from 'path';
          import { fileURLToPath } from 'url';
          
          const __filename = fileURLToPath(import.meta.url);
          const __dirname = path.dirname(__filename);
          
          // Try multiple possible locations for plugins
          const possibleDirs = [
            path.join(__dirname, '../.js/src/plugins'),
            path.join(__dirname, '../.js/plugins'),
            path.join(__dirname, '../src/plugins'),
            path.join(__dirname, '../plugins')
          ];
          
          let pluginsDir = null;
          for (const dir of possibleDirs) {
            if (fs.existsSync(dir)) {
              pluginsDir = dir;
              console.log(`Found plugins directory: ${dir}`);
              break;
            }
          }
          
          if (!pluginsDir) {
            console.error('Plugins directory not found in any of these locations:');
            possibleDirs.forEach(dir => console.error(`  - ${dir}`));
            
            // List what's actually in the project
            console.log('\nActual directory structure:');
            const listDir = (dir, indent = '') => {
              try {
                const items = fs.readdirSync(dir);
                items.slice(0, 10).forEach(item => {
                  const fullPath = path.join(dir, item);
                  const stat = fs.statSync(fullPath);
                  console.log(`${indent}${item}${stat.isDirectory() ? '/' : ''}`);
                  if (stat.isDirectory() && indent.length < 6) {
                    listDir(fullPath, indent + '  ');
                  }
                });
              } catch (e) {}
            };
            listDir(path.join(__dirname, '..'));
            
            process.exit(1);
          }
          
          const outputDir = path.join(__dirname, '../.bundled/plugins');
          
          async function bundlePlugin(inputFile, outputFile) {
            try {
              await build({
                entryPoints: [inputFile],
                bundle: true,
                format: 'iife',
                platform: 'browser',
                target: 'es2017',
                outfile: outputFile,
                minify: false,
                sourcemap: false,
                treeShaking: false,
                legalComments: 'inline',
                banner: {
                  js: '// Bundled plugin with all dependencies included\n// Built for LNReader Android\n'
                },
                footer: {
                  js: '\n// Export for compatibility\nif (typeof module !== "undefined" && module.exports) { module.exports = this; }\n'
                },
                globalName: 'LNReaderPlugin',
                external: [],
                mainFields: ['module', 'main'],
                conditions: ['import', 'require', 'default'],
                logLevel: 'error'
              });
              console.log(`‚úÖ Bundled: ${path.basename(inputFile)}`);
            } catch (error) {
              console.error(`‚ùå Failed to bundle ${inputFile}:`, error.message);
            }
          }
          
          async function bundleAllPlugins() {
            // Files to skip (build scripts, not actual plugins)
            const skipPatterns = [
              'generator.js',
              'generate-multisrc-plugins.js',
              'get_filters.js',
              'filter_refresh.js',
              'template.js'
            ];
            
            const shouldSkip = (filePath) => {
              const fileName = path.basename(filePath);
              return skipPatterns.some(pattern => fileName === pattern);
            };
            
            // Walk through all plugin files
            const walkDir = (dir, callback) => {
              const files = fs.readdirSync(dir);
              files.forEach(file => {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                if (stat.isDirectory()) {
                  walkDir(filePath, callback);
                } else if (file.endsWith('.js') && !shouldSkip(filePath)) {
                  callback(filePath);
                }
              });
            };
          
            const pluginFiles = [];
            walkDir(pluginsDir, (file) => pluginFiles.push(file));
          
            console.log(`Found ${pluginFiles.length} plugin files to bundle`);
          
            let successCount = 0;
            let failCount = 0;
            
            // Bundle each plugin
            for (const inputFile of pluginFiles) {
              const relativePath = path.relative(pluginsDir, inputFile);
              const outputFile = path.join(outputDir, relativePath);
              
              // Create output directory
              fs.mkdirSync(path.dirname(outputFile), { recursive: true });
              
              try {
                await bundlePlugin(inputFile, outputFile);
                successCount++;
              } catch (error) {
                failCount++;
              }
            }
          
            console.log(`\n‚úÖ Successfully bundled ${successCount} plugins`);
            if (failCount > 0) {
              console.log(`‚ö†Ô∏è  Failed to bundle ${failCount} files`);
            }
          }
          
          bundleAllPlugins().catch(console.error);
          EOF
          
          # Run the bundling script
          node scripts/bundle-plugins.js
          
          echo "‚úÖ All plugins bundled with dependencies"
      
      - name: Transpile to ES5 for Android compatibility (Parallel)
        run: |
          cd lnreader-source
          
          # Create Babel config for ES5 transpilation
          cat > .babelrc.json << 'EOF'
          {
            "presets": [
              [
                "@babel/preset-env",
                {
                  "targets": {
                    "rhino": "1.7"
                  },
                  "modules": false,
                  "loose": true,
                  "spec": false,
                  "useBuiltIns": false
                }
              ]
            ],
            "comments": true,
            "minified": false,
            "compact": false
          }
          EOF
          
          # Create parallel transpilation script
          cat > scripts/parallel-transpile.js << 'EOF'
          import { transformFileAsync } from '@babel/core';
          import fs from 'fs';
          import path from 'path';
          import { fileURLToPath } from 'url';
          
          const __filename = fileURLToPath(import.meta.url);
          const __dirname = path.dirname(__filename);
          
          const inputDir = path.join(__dirname, '../.bundled/plugins');
          const outputDir = path.join(__dirname, '../.bundled-es5/plugins');
          
          // Get all JS files
          function getAllFiles(dir, fileList = []) {
            const files = fs.readdirSync(dir);
            files.forEach(file => {
              const filePath = path.join(dir, file);
              if (fs.statSync(filePath).isDirectory()) {
                getAllFiles(filePath, fileList);
              } else if (file.endsWith('.js')) {
                fileList.push(filePath);
              }
            });
            return fileList;
          }
          
          // Transpile a single file
          async function transpileFile(inputFile) {
            const relativePath = path.relative(inputDir, inputFile);
            const outputFile = path.join(outputDir, relativePath);
            
            // Create output directory
            fs.mkdirSync(path.dirname(outputFile), { recursive: true });
            
            try {
              const result = await transformFileAsync(inputFile, {
                presets: [
                  ['@babel/preset-env', {
                    targets: { rhino: '1.7' },
                    modules: false,
                    loose: true,
                    spec: false,
                    useBuiltIns: false
                  }]
                ],
                comments: true,
                minified: false,
                compact: false
              });
              
              fs.writeFileSync(outputFile, result.code);
              return { success: true, file: relativePath };
            } catch (error) {
              // If transpilation fails, copy original
              fs.copyFileSync(inputFile, outputFile);
              return { success: false, file: relativePath, error: error.message };
            }
          }
          
          // Process files in parallel chunks
          async function processInParallel(files, chunkSize = 10) {
            const results = { success: 0, failed: 0 };
            
            for (let i = 0; i < files.length; i += chunkSize) {
              const chunk = files.slice(i, i + chunkSize);
              const promises = chunk.map(file => transpileFile(file));
              const chunkResults = await Promise.all(promises);
              
              chunkResults.forEach(result => {
                if (result.success) {
                  results.success++;
                  console.log(`‚úÖ ${result.file}`);
                } else {
                  results.failed++;
                  console.log(`‚ö†Ô∏è  ${result.file}: ${result.error}`);
                }
              });
              
              const progress = Math.min(i + chunkSize, files.length);
              const percent = ((progress / files.length) * 100).toFixed(1);
              console.log(`\nüìä Progress: ${progress}/${files.length} (${percent}%)\n`);
            }
            
            return results;
          }
          
          // Main execution
          async function main() {
            console.log('Finding plugin files...');
            const files = getAllFiles(inputDir);
            console.log(`Found ${files.length} files to transpile`);
            
            const startTime = Date.now();
            const results = await processInParallel(files, 20);
            const duration = ((Date.now() - startTime) / 1000).toFixed(2);
            
            console.log(`\n‚úÖ Transpilation complete in ${duration}s`);
            console.log(`   Success: ${results.success}`);
            if (results.failed > 0) {
              console.log(`   Failed: ${results.failed} (copied originals)`);
            }
          }
          
          main().catch(console.error);
          EOF
          
          echo "Transpiling bundled plugins to ES5 (parallel processing)..."
          node scripts/parallel-transpile.js
          
          echo "‚úÖ ES5 transpilation complete"
      
      - name: Copy built plugins and manifest
        run: |
          mkdir -p plugins
          
          # Copy ES5 transpiled plugins (with all dependencies included, Android compatible)
          if [ -d "lnreader-source/.bundled-es5/plugins" ]; then
            cp -r lnreader-source/.bundled-es5/plugins/* plugins/ 2>/dev/null || true
            echo "‚úÖ Copied ES5 transpiled plugins"
          elif [ -d "lnreader-source/.bundled/plugins" ]; then
            cp -r lnreader-source/.bundled/plugins/* plugins/ 2>/dev/null || true
            echo "‚úÖ Copied bundled plugins (ES2017)"
          else
            echo "‚ö†Ô∏è Bundled plugins directory not found, falling back to compiled plugins"
            if [ -d "lnreader-source/.js/src/plugins" ]; then
              cp -r lnreader-source/.js/src/plugins/* plugins/ 2>/dev/null || true
            fi
            if [ -d "lnreader-source/.js/plugins" ]; then
              cp -r lnreader-source/.js/plugins/* plugins/ 2>/dev/null || true
            fi
          fi
          
          # Update JSON manifest files with correct URLs using Node.js
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          const updateUrls = (filePath, outputPath, minified = false) => {
            if (!fs.existsSync(filePath)) return;
            
            const content = fs.readFileSync(filePath, 'utf-8');
            const data = JSON.parse(content);
            
            // Update URLs in each plugin entry
            // Only update plugin URLs, keep icons/assets pointing to original repo
            data.forEach(plugin => {
              if (plugin.url) {
                // Replace the entire URL structure
                plugin.url = plugin.url
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/src\/plugins\//g,
                    'https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/master/plugins/'
                  )
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/plugins\//g,
                    'https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/master/plugins/'
                  );
              }
              // Keep iconUrl, customJS, and customCSS pointing to original LNReader repo
              // No changes needed for these fields
            });
            
            // Write JSON - minified or formatted
            const output = minified ? JSON.stringify(data) : JSON.stringify(data, null, '\t');
            fs.writeFileSync(outputPath, output);
            console.log(`‚úÖ Updated ${path.basename(outputPath)}`);
          };
          
          updateUrls('lnreader-source/.dist/plugins.json', 'plugins/plugins.json', false);
          updateUrls('lnreader-source/.dist/plugins.min.json', 'plugins/plugins.min.json', true);
          SCRIPT
          
          # Count total plugins
          total=$(find plugins -name "*.js" -type f | wc -l)
          echo "‚úÖ Copied $total plugin files"
          
          # Show structure
          echo "Plugin structure:"
          ls -lh plugins/ | head -20
      
      - name: Generate plugin list
        run: |
          echo "# Unminified LNReader Plugins" > plugins/README.md
          echo "" >> plugins/README.md
          echo "Built from: https://github.com/LNReader/lnreader-plugins" >> plugins/README.md
          echo "" >> plugins/README.md
          
          # Count plugins by language
          for lang_dir in plugins/*/; do
            if [ -d "$lang_dir" ]; then
              lang=$(basename "$lang_dir")
              count=$(find "$lang_dir" -name "*.js" -type f | wc -l)
              echo "## $lang ($count plugins)" >> plugins/README.md
              echo "" >> plugins/README.md
              for file in "$lang_dir"*.js; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  size=$(du -h "$file" | cut -f1)
                  echo "- \`$filename\` ($size)" >> plugins/README.md
                fi
              done
              echo "" >> plugins/README.md
            fi
          done
          
          total=$(find plugins -name "*.js" -type f | wc -l)
          echo "---" >> plugins/README.md
          echo "**Total: $total plugins**" >> plugins/README.md
      
      - name: Package plugins by language
        run: |
          cd plugins
          # Create archives for each language
          for lang_dir in */; do
            if [ -d "$lang_dir" ]; then
              lang=$(basename "$lang_dir")
              if [ -n "$(ls -A "$lang_dir"*.js 2>/dev/null)" ]; then
                echo "Packaging $lang..."
                tar -czf "../${lang}-plugins.tar.gz" "$lang_dir"
              fi
            fi
          done
          cd ..
          
          # Create a complete archive
          tar -czf all-plugins.tar.gz plugins/
          
          echo "‚úÖ Created plugin archives"
          ls -lh *.tar.gz
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add plugins/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update plugins - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Unminified Plugins v${{ github.run_number }}
          body: |
            # Unminified LNReader Plugins
            
            Built from: https://github.com/LNReader/lnreader-plugins
            Build date: $(date +'%Y-%m-%d %H:%M:%S UTC')
            
            ## üì• Download
            - **all-plugins.tar.gz** - All plugins in one archive
            - **[language]-plugins.tar.gz** - Individual language archives
            - **plugins.json** - Plugin manifest with metadata
            - **plugins.min.json** - Minified plugin manifest
            
            ## üìñ Usage
            1. Download and extract the archive for your language
            2. Copy the `.js` files to your LNReader plugins directory
            3. Restart LNReader
            
            ## üîç Why Unminified?
            These plugins are built without minification, making them easier to read and debug.
            
            ## üìã Plugin Manifest
            The JSON files contain metadata for all plugins including:
            - Plugin ID, name, and version
            - Source site URL
            - Language
            - Download URLs
            - Icon URLs
          files: |
            *.tar.gz
            plugins/README.md
            plugins/plugins.json
            plugins/plugins.min.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
