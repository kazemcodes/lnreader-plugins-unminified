name: Build Unminified Plugins

on:
  workflow_dispatch:
  repository_dispatch:
    types: [lnreader-release]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Clone LNReader plugins
        run: |
          git clone --depth 1 https://github.com/LNReader/lnreader-plugins lnreader-source
          cd lnreader-source
          echo "Cloned LNReader plugins repo"
      
      - name: Disable minification in terser script
        run: |
          cd lnreader-source
          cat > scripts/terser.js << 'EOF'
          import fs from 'fs';
          
          // No-op minify function - just copies the file as-is
          const minify = function (path) {
            console.log('Skipping minification for:', path);
            // File is already there, no need to do anything
          };
          
          export { minify };
          EOF
          echo "‚úÖ Disabled minification"
      
      - name: Install dependencies
        run: |
          cd lnreader-source
          npm ci
      
      - name: Build plugins (unminified)
        run: |
          cd lnreader-source
          npm run clean:multisrc
          npm run build:multisrc
          npm run build:compile
          npm run build:manifest
      
      - name: Copy built plugins and manifest
        run: |
          mkdir -p plugins
          
          # Copy plugins from the correct location
          if [ -d "lnreader-source/.js/src/plugins" ]; then
            cp -r lnreader-source/.js/src/plugins/* plugins/ 2>/dev/null || true
          fi
          if [ -d "lnreader-source/.js/plugins" ]; then
            cp -r lnreader-source/.js/plugins/* plugins/ 2>/dev/null || true
          fi
          
          # Update JSON manifest files with correct URLs using Node.js
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          const updateUrls = (filePath, outputPath, minified = false) => {
            if (!fs.existsSync(filePath)) return;
            
            const content = fs.readFileSync(filePath, 'utf-8');
            const data = JSON.parse(content);
            
            // Update URLs in each plugin entry
            // Only update plugin URLs, keep icons/assets pointing to original repo
            data.forEach(plugin => {
              if (plugin.url) {
                // Replace the entire URL structure
                plugin.url = plugin.url
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/src\/plugins\//g,
                    'https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/master/plugins/'
                  )
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/plugins\//g,
                    'https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/master/plugins/'
                  );
              }
              // Keep iconUrl, customJS, and customCSS pointing to original LNReader repo
              // No changes needed for these fields
            });
            
            // Write JSON - minified or formatted
            const output = minified ? JSON.stringify(data) : JSON.stringify(data, null, '\t');
            fs.writeFileSync(outputPath, output);
            console.log(`‚úÖ Updated ${path.basename(outputPath)}`);
          };
          
          updateUrls('lnreader-source/.dist/plugins.json', 'plugins/plugins.json', false);
          updateUrls('lnreader-source/.dist/plugins.min.json', 'plugins/plugins.min.json', true);
          SCRIPT
          
          # Count total plugins
          total=$(find plugins -name "*.js" -type f | wc -l)
          echo "‚úÖ Copied $total plugin files"
          
          # Show structure
          echo "Plugin structure:"
          ls -lh plugins/ | head -20
      
      - name: Generate plugin list
        run: |
          echo "# Unminified LNReader Plugins" > plugins/README.md
          echo "" >> plugins/README.md
          echo "Built from: https://github.com/LNReader/lnreader-plugins" >> plugins/README.md
          echo "" >> plugins/README.md
          
          # Count plugins by language
          for lang_dir in plugins/*/; do
            if [ -d "$lang_dir" ]; then
              lang=$(basename "$lang_dir")
              count=$(find "$lang_dir" -name "*.js" -type f | wc -l)
              echo "## $lang ($count plugins)" >> plugins/README.md
              echo "" >> plugins/README.md
              for file in "$lang_dir"*.js; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  size=$(du -h "$file" | cut -f1)
                  echo "- \`$filename\` ($size)" >> plugins/README.md
                fi
              done
              echo "" >> plugins/README.md
            fi
          done
          
          total=$(find plugins -name "*.js" -type f | wc -l)
          echo "---" >> plugins/README.md
          echo "**Total: $total plugins**" >> plugins/README.md
      
      - name: Package plugins by language
        run: |
          cd plugins
          # Create archives for each language
          for lang_dir in */; do
            if [ -d "$lang_dir" ]; then
              lang=$(basename "$lang_dir")
              if [ -n "$(ls -A "$lang_dir"*.js 2>/dev/null)" ]; then
                echo "Packaging $lang..."
                tar -czf "../${lang}-plugins.tar.gz" "$lang_dir"
              fi
            fi
          done
          cd ..
          
          # Create a complete archive
          tar -czf all-plugins.tar.gz plugins/
          
          echo "‚úÖ Created plugin archives"
          ls -lh *.tar.gz
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add plugins/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update plugins - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Unminified Plugins v${{ github.run_number }}
          body: |
            # Unminified LNReader Plugins
            
            Built from: https://github.com/LNReader/lnreader-plugins
            Build date: $(date +'%Y-%m-%d %H:%M:%S UTC')
            
            ## üì• Download
            - **all-plugins.tar.gz** - All plugins in one archive
            - **[language]-plugins.tar.gz** - Individual language archives
            - **plugins.json** - Plugin manifest with metadata
            - **plugins.min.json** - Minified plugin manifest
            
            ## üìñ Usage
            1. Download and extract the archive for your language
            2. Copy the `.js` files to your LNReader plugins directory
            3. Restart LNReader
            
            ## üîç Why Unminified?
            These plugins are built without minification, making them easier to read and debug.
            
            ## üìã Plugin Manifest
            The JSON files contain metadata for all plugins including:
            - Plugin ID, name, and version
            - Source site URL
            - Language
            - Download URLs
            - Icon URLs
          files: |
            *.tar.gz
            plugins/README.md
            plugins/plugins.json
            plugins/plugins.min.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
