name: Build Unminified Plugins

on:
  workflow_dispatch:
  repository_dispatch:
    types: [lnreader-release]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo branch
        uses: actions/checkout@v4
        with:
          ref: repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Clone and build LNReader plugins
        run: |
          git clone --depth 1 https://github.com/LNReader/lnreader-plugins lnreader-source
          cd lnreader-source
          
          echo "Installing dependencies..."
          npm ci
          
          echo "Building plugins..."
          npm run clean:multisrc
          npm run build:multisrc
          npm run build:compile
          npm run build:manifest
          
          echo "âœ… Build complete"
          
          # Show plugin count
          if [ -d ".js/src/plugins" ]; then
            total=$(find .js/src/plugins -name "*.js" -type f | wc -l)
            echo "Total compiled plugins: $total"
          fi
      
      - name: Install bundling tools
        run: |
          npm install --no-save esbuild esbuild-plugin-polyfill-node
      
      - name: Find plugins directory
        run: |
          cd lnreader-source
          
          echo "Searching for plugins directory..."
          echo ""
          echo "Root structure:"
          ls -la | head -20
          echo ""
          
          # Check possible locations
          for dir in ".js/src/plugins" ".js/plugins" "src/plugins" "plugins" "dist/plugins" ".dist/plugins"; do
            if [ -d "$dir" ]; then
              echo "âœ… Found: $dir"
              ls -la "$dir" | head -10
            fi
          done
          
          # Find any .js files in plugins directories
          echo ""
          echo "Searching for plugin files..."
          find . -type f -name "*.js" -path "*/plugins/*" | head -20
      
      - name: Bundle all plugins
        run: |
          cd lnreader-source
          
          echo "Creating bundling script..."
          
          # Create bundling script
          cat > bundle-all-plugins.js << 'EOF'
          import { build } from 'esbuild';
          import { polyfillNode } from 'esbuild-plugin-polyfill-node';
          import fs from 'fs';
          import path from 'path';
          
          // Try multiple possible locations
          const possibleDirs = [
            path.join('.js', 'src', 'plugins'),
            path.join('.js', 'plugins'),
            path.join('src', 'plugins'),
            path.join('plugins'),
            path.join('dist', 'plugins'),
            path.join('.dist', 'plugins')
          ];
          
          let pluginsBaseDir = null;
          for (const dir of possibleDirs) {
            if (fs.existsSync(dir)) {
              pluginsBaseDir = dir;
              console.log(`Found plugins directory: ${dir}\n`);
              break;
            }
          }
          
          if (!pluginsBaseDir) {
            console.error('Plugins directory not found in any of these locations:');
            possibleDirs.forEach(dir => console.error(`  - ${dir}`));
            
            console.log('\nActual directory structure:');
            const listDir = (dir, indent = '', depth = 0) => {
              if (depth > 2) return;
              try {
                const items = fs.readdirSync(dir);
                items.slice(0, 10).forEach(item => {
                  const fullPath = path.join(dir, item);
                  const stat = fs.statSync(fullPath);
                  console.log(`${indent}${item}${stat.isDirectory() ? '/' : ''}`);
                  if (stat.isDirectory() && depth < 2) {
                    listDir(fullPath, indent + '  ', depth + 1);
                  }
                });
              } catch (e) {}
            };
            listDir('.');
            
            process.exit(1);
          }
          
          async function bundlePlugin(inputFile, outputFile) {
            const config = {
              entryPoints: [inputFile],
              bundle: true,
              format: 'iife',
              platform: 'browser',
              target: 'es2020',
              outfile: outputFile,
              minify: false,
              keepNames: true,
              sourcemap: false,
              treeShaking: false,
              legalComments: 'inline',
              banner: {
                js: '// Bundled plugin with all dependencies included\n// Built for LNReader Android (J2V8 - V8 JavaScript Engine)\n// Supports: ES6+, async/await, Promises, arrow functions\n'
              },
              footer: {
                js: '\n// Export for compatibility\nif (typeof module !== "undefined" && module.exports) { module.exports = this; }\n'
              },
              globalName: 'LNReaderPlugin',
              plugins: [
                polyfillNode({
                  polyfills: {
                    stream: true,
                    buffer: true,
                    process: true,
                    util: true,
                    events: true,
                    fs: false,
                    path: false
                  }
                })
              ],
              external: [],
              mainFields: ['module', 'main'],
              conditions: ['import', 'require', 'default'],
              logLevel: 'warning'
            };
            
            try {
              await build(config);
              return true;
            } catch (error) {
              console.error(`âŒ Failed to bundle ${path.basename(inputFile)}:`);
              console.error(`   Error: ${error.message}`);
              if (error.errors && error.errors.length > 0) {
                error.errors.slice(0, 3).forEach(err => {
                  console.error(`   ${err.text}`);
                });
              }
              return false;
            }
          }
          
          async function bundleAllPlugins() {
            const skipPatterns = ['generator.js', 'generate-multisrc-plugins.js', 'get_filters.js', 'filter_refresh.js', 'template.js'];
            
            const languages = fs.readdirSync(pluginsBaseDir).filter(item => {
              const fullPath = path.join(pluginsBaseDir, item);
              return fs.statSync(fullPath).isDirectory();
            });
            
            console.log(`Found ${languages.length} languages\n`);
            
            let totalSuccess = 0;
            let totalFiles = 0;
            
            for (const language of languages) {
              const pluginsDir = path.join(pluginsBaseDir, language);
              const outputDir = path.join('.bundled', 'plugins', language);
              
              const pluginFiles = fs.readdirSync(pluginsDir)
                .filter(file => file.endsWith('.js') && !skipPatterns.includes(file))
                .map(file => path.join(pluginsDir, file));
              
              if (pluginFiles.length === 0) continue;
              
              console.log(`\nðŸ“¦ Bundling ${language} (${pluginFiles.length} plugins)...`);
              fs.mkdirSync(outputDir, { recursive: true });
              
              let successCount = 0;
              
              for (const inputFile of pluginFiles) {
                const fileName = path.basename(inputFile);
                const outputFile = path.join(outputDir, fileName);
                
                const success = await bundlePlugin(inputFile, outputFile);
                if (success) {
                  successCount++;
                  if (successCount % 10 === 0) {
                    console.log(`  Progress: ${successCount}/${pluginFiles.length}...`);
                  }
                }
              }
              
              console.log(`âœ… ${language}: ${successCount}/${pluginFiles.length} plugins bundled`);
              totalSuccess += successCount;
              totalFiles += pluginFiles.length;
            }
          
            console.log(`\nðŸŽ‰ Total: ${totalSuccess}/${totalFiles} plugins bundled successfully`);
          }
          
          bundleAllPlugins().catch(console.error);
          EOF
          
          echo "Starting bundling process..."
          node bundle-all-plugins.js
          
          echo ""
          echo "âœ… All plugins bundled"
          
          cd ..
      
      - name: Verify bundled plugins
        run: |
          cd lnreader-source
          
          echo "Verifying bundled plugins..."
          
          # Count bundled files
          total=$(find .bundled/plugins -name "*.js" -type f 2>/dev/null | wc -l)
          echo "Total bundled files: $total"
          
          # Show sample
          first_file=$(find .bundled/plugins -name "*.js" -type f 2>/dev/null | head -1)
          if [ -n "$first_file" ]; then
            echo ""
            echo "Sample from $(basename "$first_file"):"
            head -3 "$first_file"
            echo "..."
          fi
          
          echo ""
          echo "âœ… Verification complete - Modern JS (ES2020) for J2V8"
          
          cd ..
      
      - name: Organize plugins
        run: |
          # Create plugins directory
          mkdir -p plugins
          
          # Copy bundled plugins
          cp -r lnreader-source/.bundled/plugins/* plugins/ 2>/dev/null || true
          
          echo "âœ… Organized plugins (Modern JS/ES2020 for J2V8)"
          
          # Count plugins by language
          echo ""
          echo "Plugin count by language:"
          for lang_dir in plugins/*/; do
            if [ -d "$lang_dir" ]; then
              lang=$(basename "$lang_dir")
              count=$(find "$lang_dir" -name "*.js" -type f 2>/dev/null | wc -l)
              echo "  $lang: $count plugins"
            fi
          done
      
      - name: Update manifest URLs
        run: |
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          const updateUrls = (filePath, outputPath, minified = false) => {
            if (!fs.existsSync(filePath)) {
              console.log(`âš ï¸  Source file not found: ${filePath}`);
              return;
            }
            
            const content = fs.readFileSync(filePath, 'utf-8');
            const data = JSON.parse(content);
            
            data.forEach(plugin => {
              if (plugin.url) {
                plugin.url = plugin.url
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/src\/plugins\//g,
                    'https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/repo/plugins/'
                  )
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/plugins\//g,
                    'https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/repo/plugins/'
                  );
              }
            });
            
            const output = minified ? JSON.stringify(data) : JSON.stringify(data, null, '\t');
            fs.writeFileSync(outputPath, output);
            console.log(`âœ… Updated ${path.basename(outputPath)}`);
          };
          
          // Create manifest files in plugins directory
          updateUrls('lnreader-source/.dist/plugins.json', 'plugins/plugins.json', false);
          updateUrls('lnreader-source/.dist/plugins.min.json', 'plugins/plugins.min.json', true);
          SCRIPT
        continue-on-error: true
      
      - name: Generate manifest if missing
        run: |
          if [ ! -f ".dist/plugins.json" ]; then
            echo "âš ï¸  Manifest not found, regenerating..."
            git clone --depth 1 https://github.com/LNReader/lnreader-plugins lnreader-source
            cd lnreader-source
            npm ci
            npm run clean:multisrc
            npm run build:multisrc
            npm run build:compile
            npm run build:manifest
            cd ..
            mkdir -p .dist
            cp lnreader-source/.dist/* .dist/ 2>/dev/null || true
            rm -rf lnreader-source
            echo "âœ… Manifest regenerated"
          else
            echo "âœ… Manifest found"
          fi
      
      - name: Download all bundled plugins (Modern JS)
        uses: actions/download-artifact@v4
        with:
          pattern: bundled-*
          path: temp-bundled/
          merge-multiple: true
      
      - name: Download all J2V8-ready plugins
        uses: actions/download-artifact@v4
        with:
          pattern: j2v8-*
          path: temp-j2v8/
          merge-multiple: true
      
      - name: Organize plugins
        run: |
          # Create single plugins directory
          mkdir -p plugins
          
          # Copy J2V8-ready plugins
          if [ -d "temp-j2v8" ]; then
            cp -r temp-j2v8/* plugins/ 2>/dev/null || true
            echo "âœ… Copied plugins (Modern JS/ES2020 for J2V8)"
          fi
          
          # Count plugins by language
          echo ""
          echo "Plugin count by language:"
          for lang_dir in plugins/*/; do
            if [ -d "$lang_dir" ]; then
              lang=$(basename "$lang_dir")
              count=$(find "$lang_dir" -name "*.js" -type f 2>/dev/null | wc -l)
              echo "  $lang: $count plugins"
            fi
          done
          
          # Clean up temp directories
          rm -rf temp-bundled temp-j2v8
      
      - name: Update manifest URLs
        run: |
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          const updateUrls = (filePath, outputPath, minified = false) => {
            if (!fs.existsSync(filePath)) {
              console.log(`âš ï¸  Source file not found: ${filePath}`);
              return;
            }
            
            const content = fs.readFileSync(filePath, 'utf-8');
            const data = JSON.parse(content);
            
            data.forEach(plugin => {
              if (plugin.url) {
                plugin.url = plugin.url
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/src\/plugins\//g,
                    'https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/repo/plugins/'
                  )
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/plugins\//g,
                    'https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/repo/plugins/'
                  );
              }
            });
            
            const output = minified ? JSON.stringify(data) : JSON.stringify(data, null, '\t');
            fs.writeFileSync(outputPath, output);
            console.log(`âœ… Updated ${path.basename(outputPath)}`);
          };
          
          // Create manifest files in plugins directory
          updateUrls('.dist/plugins.json', 'plugins/plugins.json', false);
          updateUrls('.dist/plugins.min.json', 'plugins/plugins.min.json', true);
          SCRIPT
      
      - name: Generate README
        run: |
          cat > plugins/README.md << 'EOF'
          # LNReader Plugins - Bundled & Unminified (J2V8)
          
          **Modern JavaScript plugins for LNReader (J2V8 - V8 JavaScript Engine)**
          
          Built from: https://github.com/LNReader/lnreader-plugins
          
          ## Features
          - âœ… All dependencies bundled (cheerio, dayjs, etc.)
          - âœ… Non-minified for easy debugging
          - âœ… ES2020 target (full ES6+ support)
          - âœ… Native async/await and Promises
          - âœ… Arrow functions, classes, template literals
          - âœ… Self-contained - no external modules needed
          
          ## JavaScript Engine
          
          These plugins are optimized for **J2V8** (V8 JavaScript engine), which provides:
          - âœ… Full ES6+ compatibility
          - âœ… Native Promise/async/await support
          - âœ… Same engine as Chrome and Node.js
          - âœ… No ES5 transpilation needed
          
          ## Structure
          
          ```
          plugins/
          â”œâ”€â”€ plugins.json          # Plugin manifest
          â”œâ”€â”€ plugins.min.json      # Minified manifest
          â”œâ”€â”€ english/              # English plugins
          â”œâ”€â”€ chinese/              # Chinese plugins
          â”œâ”€â”€ spanish/              # Spanish plugins
          â””â”€â”€ ...                   # Other languages
          ```
          
          ## Usage
          
          1. Download the plugins for your language
          2. Copy `.js` files to your LNReader plugins directory
          3. Restart LNReader
          4. Enjoy native V8 performance!
          EOF
          
          # Count total plugins
          total=$(find plugins -name "*.js" -type f 2>/dev/null | wc -l)
          echo "" >> plugins/README.md
          echo "**Total: $total plugins**" >> plugins/README.md
      
      - name: Commit to repo branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add plugins/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update plugins - $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin repo
            echo "âœ… Pushed to repo branch"
          fi
      
      - name: Package plugins
        run: |
          # Create single archive with all plugins
          tar -czf lnreader-plugins-j2v8.tar.gz plugins/
          
          # Create individual language archives
          cd plugins
          for lang_dir in */; do
            if [ -d "$lang_dir" ]; then
              lang=$(basename "$lang_dir")
              if [ -n "$(ls -A "$lang_dir"*.js 2>/dev/null)" ]; then
                echo "Packaging $lang..."
                tar -czf "../${lang}-plugins.tar.gz" "$lang_dir"
              fi
            fi
          done
          cd ..
          
          echo "âœ… Created plugin archives"
          ls -lh *.tar.gz
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: LNReader Plugins v${{ github.run_number }} (J2V8)
          body: |
            # LNReader Plugins - Bundled & Unminified (J2V8)
            
            Built from: https://github.com/LNReader/lnreader-plugins
            
            ## ðŸš€ JavaScript Engine: J2V8 (V8)
            
            These plugins are optimized for **J2V8**, which uses the V8 JavaScript engine (same as Chrome and Node.js).
            
            ### âœ… Full Modern JavaScript Support
            - Native async/await and Promises
            - Arrow functions and classes
            - Template literals
            - Destructuring and spread operators
            - ES2020 target - no ES5 transpilation needed!
            
            ## ðŸ“¥ Download Options
            
            ### All Plugins
            - **lnreader-plugins-j2v8.tar.gz** - All plugins (all languages)
            
            ### By Language
            - **english-plugins.tar.gz** - English plugins only
            - **chinese-plugins.tar.gz** - Chinese plugins only
            - **spanish-plugins.tar.gz** - Spanish plugins only
            - And more...
            
            ### Manifest Files
            - **plugins.json** - Plugin manifest with metadata
            - **plugins.min.json** - Minified plugin manifest
            
            ## âœ¨ Features
            - âœ… All dependencies bundled (cheerio, dayjs, etc.)
            - âœ… Non-minified for easy debugging
            - âœ… ES2020 with full ES6+ support
            - âœ… Self-contained - no external modules needed
            - âœ… Optimized for V8 engine performance
            
            ## ðŸ“– Usage
            
            1. Download `lnreader-plugins-j2v8.tar.gz` or a specific language archive
            2. Extract and copy `.js` files to your LNReader plugins directory
            3. Restart LNReader
            4. Enjoy native V8 performance!
            
            ## ðŸ“‚ Structure
            
            ```
            plugins/
            â”œâ”€â”€ plugins.json          # Plugin manifest
            â”œâ”€â”€ plugins.min.json      # Minified manifest
            â”œâ”€â”€ english/              # English plugins
            â”œâ”€â”€ chinese/              # Chinese plugins
            â””â”€â”€ ...                   # Other languages
            ```
          files: |
            *.tar.gz
            plugins/plugins.json
            plugins/plugins.min.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
