name: Build Unminified Plugins

on:
  workflow_dispatch:
  repository_dispatch:
    types: [lnreader-release]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Clone and build TypeScript
        run: |
          git clone --depth 1 https://github.com/LNReader/lnreader-plugins lnreader-source
          cd lnreader-source
          npm ci
          npm run clean:multisrc
          npm run build:multisrc
          npm run build:compile
          npm run build:manifest
      
      - name: Generate build matrix
        id: set-matrix
        run: |
          cd lnreader-source
          
          # Find all plugin directories (language folders)
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          // Try multiple possible locations
          const possibleDirs = [
            '.js/src/plugins',
            '.js/plugins',
            'src/plugins',
            'plugins'
          ];
          
          let pluginsDir = null;
          for (const dir of possibleDirs) {
            if (fs.existsSync(dir)) {
              pluginsDir = dir;
              console.log(`Found plugins directory: ${dir}`);
              break;
            }
          }
          
          if (!pluginsDir) {
            console.error('Plugins directory not found. Checking structure:');
            console.log('Current directory:', process.cwd());
            console.log('Contents:', fs.readdirSync('.').join(', '));
            
            // Check if .js exists
            if (fs.existsSync('.js')) {
              console.log('.js contents:', fs.readdirSync('.js').join(', '));
              if (fs.existsSync('.js/src')) {
                console.log('.js/src contents:', fs.readdirSync('.js/src').join(', '));
              }
            }
            
            process.exit(1);
          }
          
          const languages = fs.readdirSync(pluginsDir).filter(item => {
            const fullPath = path.join(pluginsDir, item);
            return fs.statSync(fullPath).isDirectory();
          });
          
          console.log(`Found ${languages.length} language directories`);
          
          // Create matrix with language chunks
          const matrix = [];
          
          languages.forEach(lang => {
            const langPath = path.join(pluginsDir, lang);
            const plugins = fs.readdirSync(langPath).filter(f => f.endsWith('.js'));
            
            console.log(`${lang}: ${plugins.length} plugins`);
            
            // Split English into chunks of 20 plugins per runner
            if (lang === 'english' && plugins.length > 20) {
              const chunkSize = 20;
              const chunks = Math.ceil(plugins.length / chunkSize);
              
              for (let i = 0; i < chunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, plugins.length);
                const chunkPlugins = plugins.slice(start, end);
                
                matrix.push({
                  language: lang,
                  chunk: i + 1,
                  totalChunks: chunks,
                  plugins: chunkPlugins.join(',')
                });
                
                console.log(`  Chunk ${i + 1}/${chunks}: ${chunkPlugins.length} plugins`);
              }
            } else {
              // Other languages - no chunking
              matrix.push({
                language: lang,
                chunk: 1,
                totalChunks: 1,
                plugins: 'all'
              });
            }
          });
          
          console.log(`\nTotal matrix jobs: ${matrix.length}`);
          
          // Output for GitHub Actions
          const output = JSON.stringify(matrix);
          fs.writeFileSync(process.env.GITHUB_OUTPUT || '/dev/stdout', `matrix=${output}\n`, { flag: 'a' });
          SCRIPT
      
      - name: Verify build output
        run: |
          cd lnreader-source
          echo "Checking for compiled plugins..."
          if [ ! -d ".js" ]; then
            echo "âŒ .js directory not found!"
            echo "Available directories:"
            ls -la
            exit 1
          fi
          
          echo "âœ… Found .js directory"
          ls -la .js/
          
          if [ -d ".js/src/plugins" ]; then
            echo "âœ… Found .js/src/plugins"
            plugin_count=$(find .js/src/plugins -name "*.js" -type f | wc -l)
            echo "Total plugins: $plugin_count"
          fi
      
      - name: Upload compiled plugins
        uses: actions/upload-artifact@v4
        with:
          name: compiled-plugins
          path: lnreader-source/.js/
          retention-days: 1
      
      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest
          path: lnreader-source/.dist/
          retention-days: 1
  
  bundle:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
      max-parallel: 20
      fail-fast: false
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Clone and build LNReader plugins
        run: |
          git clone --depth 1 https://github.com/LNReader/lnreader-plugins lnreader-source
          cd lnreader-source
          npm ci
          npm run clean:multisrc
          npm run build:multisrc
          npm run build:compile
          echo "âœ… Build complete"
          
          # Debug: Show actual output structure
          echo ""
          echo "=== Build output structure ==="
          echo "Root directories:"
          ls -la | grep "^d"
          echo ""
          
          # Find where plugins actually are
          echo "Searching for compiled plugins..."
          find . -type f -name "*.js" -path "*/plugins/*" | head -20
          echo ""
          
          # Check common locations
          for dir in ".js" "dist" "build" "lib" "out"; do
            if [ -d "$dir" ]; then
              echo "Found $dir directory:"
              ls -la "$dir" | head -10
            fi
          done
      
      - name: Verify language plugins exist
        run: |
          cd lnreader-source
          if [ -d ".js/src/plugins/${{ matrix.language }}" ]; then
            echo "âœ… Found language directory: ${{ matrix.language }}"
            if [ "${{ matrix.chunk }}" != "1" ] || [ "${{ matrix.totalChunks }}" != "1" ]; then
              echo "Processing chunk ${{ matrix.chunk }}/${{ matrix.totalChunks }}"
            fi
            plugin_count=$(ls -1 .js/src/plugins/${{ matrix.language }}/*.js 2>/dev/null | wc -l)
            echo "Total plugins in ${{ matrix.language }}: $plugin_count"
          else
            echo "âš ï¸  No plugins found for ${{ matrix.language }}, skipping..."
            exit 0
          fi
      
      - name: Install bundling tools
        run: |
          npm install --no-save esbuild @babel/core @babel/cli @babel/preset-env \
            @babel/plugin-transform-arrow-functions \
            @babel/plugin-transform-block-scoping \
            @babel/plugin-transform-classes \
            @babel/plugin-transform-destructuring \
            @babel/plugin-transform-parameters \
            @babel/plugin-transform-shorthand-properties \
            @babel/plugin-transform-spread \
            @babel/plugin-transform-template-literals \
            @babel/plugin-transform-object-rest-spread \
            esbuild-plugin-polyfill-node
      
      - name: Bundle plugins - ${{ matrix.language }} (chunk ${{ matrix.chunk }}/${{ matrix.totalChunks }})
        run: |
          cd lnreader-source
          
          # Create bundling script
          cat > bundle-language.js << 'EOF'
          import { build } from 'esbuild';
          import { polyfillNode } from 'esbuild-plugin-polyfill-node';
          import fs from 'fs';
          import path from 'path';
          
          const language = process.argv[2];
          if (!language) {
            console.error('Language parameter required');
            process.exit(1);
          }
          
          // Try multiple possible locations
          const possibleDirs = [
            path.join('.js', 'src', 'plugins', language),
            path.join('.js', 'plugins', language),
            path.join('src', 'plugins', language),
            path.join('plugins', language)
          ];
          
          let pluginsDir = null;
          for (const dir of possibleDirs) {
            if (fs.existsSync(dir)) {
              pluginsDir = dir;
              console.log(`Found plugins directory: ${dir}`);
              break;
            }
          }
          
          if (!pluginsDir) {
            console.error(`Plugins directory not found for language: ${language}`);
            console.error('Tried locations:');
            possibleDirs.forEach(dir => console.error(`  - ${dir}`));
            
            // Show what actually exists
            console.log('\nActual structure:');
            if (fs.existsSync('.js')) {
              console.log('.js contents:', fs.readdirSync('.js').join(', '));
              if (fs.existsSync('.js/src')) {
                console.log('.js/src contents:', fs.readdirSync('.js/src').join(', '));
                if (fs.existsSync('.js/src/plugins')) {
                  console.log('.js/src/plugins contents:', fs.readdirSync('.js/src/plugins').join(', '));
                }
              }
            }
            process.exit(1);
          }
          
          const outputDir = path.join('.bundled', 'plugins', language);
          
          async function bundlePlugin(inputFile, outputFile) {
            const config = {
              entryPoints: [inputFile],
              bundle: true,
              format: 'iife',
              platform: 'browser',
              target: 'es2017',
              outfile: outputFile,
              minify: false,
              keepNames: true,
              sourcemap: false,
              treeShaking: false,
              legalComments: 'inline',
              banner: {
                js: '// Bundled plugin with all dependencies included\n// Built for LNReader Android\n'
              },
              footer: {
                js: '\n// Export for compatibility\nif (typeof module !== "undefined" && module.exports) { module.exports = this; }\n'
              },
              globalName: 'LNReaderPlugin',
              plugins: [
                polyfillNode({
                  polyfills: {
                    stream: true,
                    buffer: true,
                    process: true,
                    util: true,
                    events: true,
                    fs: false,
                    path: false
                  }
                })
              ],
              external: [],
              mainFields: ['module', 'main'],
              conditions: ['import', 'require', 'default'],
              logLevel: 'warning'
            };
            
            try {
              await build(config);
              return true;
            } catch (error) {
              console.error(`âŒ Failed to bundle ${path.basename(inputFile)}:`);
              console.error(`   Error: ${error.message}`);
              if (error.errors && error.errors.length > 0) {
                error.errors.slice(0, 3).forEach(err => {
                  console.error(`   ${err.text}`);
                });
              }
              return false;
            }
          }
          
          async function bundleLanguagePlugins() {
            const skipPatterns = ['generator.js', 'generate-multisrc-plugins.js', 'get_filters.js', 'filter_refresh.js', 'template.js'];
            
            // Get plugin list from arguments
            const pluginList = process.argv[3];
            
            let pluginFiles;
            if (pluginList && pluginList !== 'all') {
              // Process specific plugins (for chunked languages)
              const pluginNames = pluginList.split(',');
              pluginFiles = pluginNames.map(name => path.join(pluginsDir, name));
              console.log(`Bundling ${pluginFiles.length} plugins (chunk) for ${language}...\n`);
            } else {
              // Process all plugins in the language
              pluginFiles = fs.readdirSync(pluginsDir)
                .filter(file => file.endsWith('.js') && !skipPatterns.includes(file))
                .map(file => path.join(pluginsDir, file));
              console.log(`Bundling ${pluginFiles.length} plugins for ${language}...\n`);
            }
          
            fs.mkdirSync(outputDir, { recursive: true });
            
            let successCount = 0;
            
            for (const inputFile of pluginFiles) {
              const fileName = path.basename(inputFile);
              const outputFile = path.join(outputDir, fileName);
              
              const success = await bundlePlugin(inputFile, outputFile);
              if (success) {
                successCount++;
                console.log(`âœ… ${fileName}`);
              }
            }
          
            console.log(`\nâœ… Bundled ${successCount}/${pluginFiles.length} plugins for ${language}`);
          }
          
          bundleLanguagePlugins().catch(console.error);
          EOF
          
          # Run the bundling script for this language/chunk
          node bundle-language.js "${{ matrix.language }}" "${{ matrix.plugins }}"
          
          cd ..
      
      - name: Transpile to ES5 using Babel - ${{ matrix.language }}
        run: |
          cd lnreader-source
          
          echo "Transpiling ${{ matrix.language }} plugins to ES5..."
          
          # Count files to transpile
          file_count=$(find .bundled/plugins/${{ matrix.language }} -name "*.js" -type f 2>/dev/null | wc -l)
          echo "Files to transpile: $file_count"
          
          if [ "$file_count" -eq 0 ]; then
            echo "âš ï¸  No files to transpile, skipping..."
            exit 0
          fi
          
          # Create Babel config for aggressive ES5 transpilation
          cat > .babelrc << 'EOF'
          {
            "presets": [
              [
                "@babel/preset-env",
                {
                  "targets": {
                    "ie": "9"
                  },
                  "modules": "commonjs",
                  "loose": true,
                  "spec": false,
                  "forceAllTransforms": true,
                  "useBuiltIns": false
                }
              ]
            ],
            "plugins": [
              ["@babel/plugin-transform-arrow-functions", { "spec": false }],
              ["@babel/plugin-transform-block-scoping", { "throwIfClosureRequired": false }],
              "@babel/plugin-transform-classes",
              ["@babel/plugin-transform-destructuring", { "loose": true }],
              "@babel/plugin-transform-parameters",
              "@babel/plugin-transform-shorthand-properties",
              ["@babel/plugin-transform-spread", { "loose": true }],
              "@babel/plugin-transform-template-literals",
              ["@babel/plugin-transform-object-rest-spread", { "loose": true, "useBuiltIns": true }]
            ],
            "comments": true,
            "minified": false,
            "compact": false
          }
          EOF
          
          # Transpile this language's plugins
          mkdir -p .bundled-es5/plugins/${{ matrix.language }}
          
          echo "Starting Babel transpilation..."
          npx babel .bundled/plugins/${{ matrix.language }} \
            --out-dir .bundled-es5/plugins/${{ matrix.language }} \
            --no-babelrc \
            --config-file ./.babelrc
          
          # Verify transpilation - check for arrow functions
          echo ""
          echo "Verifying ES5 compatibility..."
          if grep -r "=>" .bundled-es5/plugins/${{ matrix.language }}/*.js 2>/dev/null | head -5; then
            echo "âš ï¸  WARNING: Arrow functions still found in output!"
            echo "Checking first file for issues..."
            first_file=$(find .bundled-es5/plugins/${{ matrix.language }} -name "*.js" -type f | head -1)
            echo "First 30 lines of $first_file:"
            head -30 "$first_file"
          else
            echo "âœ… No arrow functions found - ES5 compatible!"
          fi
          
          # Final count
          final_count=$(find .bundled-es5/plugins/${{ matrix.language }} -name "*.js" -type f 2>/dev/null | wc -l)
          echo ""
          echo "âœ… ES5 transpilation complete for ${{ matrix.language }}"
          echo "   Transpiled: $final_count files"
          
          cd ..
      
      - name: Upload bundled plugins (ES2017)
        uses: actions/upload-artifact@v4
        with:
          name: bundled-${{ matrix.language }}-${{ matrix.chunk }}
          path: lnreader-source/.bundled/plugins/${{ matrix.language }}/
          retention-days: 1
      
      - name: Upload ES5 plugins
        uses: actions/upload-artifact@v4
        with:
          name: es5-${{ matrix.language }}-${{ matrix.chunk }}
          path: lnreader-source/.bundled-es5/plugins/${{ matrix.language }}/
          retention-days: 1
  
  collect:
    needs: [prepare, bundle]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo branch
        uses: actions/checkout@v4
        with:
          ref: repo
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Download manifest
        uses: actions/download-artifact@v4
        with:
          name: manifest
          path: .dist/
      
      - name: Download all bundled plugins
        uses: actions/download-artifact@v4
        with:
          pattern: bundled-*
          path: temp-bundled/
          merge-multiple: true
      
      - name: Download all ES5 plugins
        uses: actions/download-artifact@v4
        with:
          pattern: es5-*
          path: temp-es5/
          merge-multiple: true
      
      - name: Organize plugins
        run: |
          # Create directory structure
          mkdir -p plugins-android plugins-desktop plugins
          
          # Copy ES5 plugins for Android
          if [ -d "temp-es5" ]; then
            cp -r temp-es5/* plugins-android/ 2>/dev/null || true
            echo "âœ… Copied ES5 plugins for Android"
          fi
          
          # Copy modern JS plugins for Desktop
          if [ -d "temp-bundled" ]; then
            cp -r temp-bundled/* plugins-desktop/ 2>/dev/null || true
            echo "âœ… Copied modern JS plugins for Desktop"
          fi
          
          # Backward compatibility - copy Android version to plugins/
          cp -r plugins-android/* plugins/ 2>/dev/null || true
          
          # Clean up temp directories
          rm -rf temp-bundled temp-es5
      
      - name: Update manifest URLs
        run: |
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          const updateUrls = (filePath, outputPath, targetDir, minified = false) => {
            if (!fs.existsSync(filePath)) {
              console.log(`âš ï¸  Source file not found: ${filePath}`);
              return;
            }
            
            const content = fs.readFileSync(filePath, 'utf-8');
            const data = JSON.parse(content);
            
            data.forEach(plugin => {
              if (plugin.url) {
                plugin.url = plugin.url
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/src\/plugins\//g,
                    `https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/repo/${targetDir}/`
                  )
                  .replace(
                    /https:\/\/raw\.githubusercontent\.com\/LNReader\/lnreader-plugins\/[^/]+\/\.js\/plugins\//g,
                    `https://raw.githubusercontent.com/kazemcodes/lnreader-plugins-unminified/repo/${targetDir}/`
                  );
              }
            });
            
            const output = minified ? JSON.stringify(data) : JSON.stringify(data, null, '\t');
            fs.writeFileSync(outputPath, output);
            console.log(`âœ… Updated ${path.basename(outputPath)}`);
          };
          
          updateUrls('.dist/plugins.json', 'plugins-android/plugins.json', 'plugins-android', false);
          updateUrls('.dist/plugins.min.json', 'plugins-android/plugins.min.json', 'plugins-android', true);
          updateUrls('.dist/plugins.json', 'plugins-desktop/plugins.json', 'plugins-desktop', false);
          updateUrls('.dist/plugins.min.json', 'plugins-desktop/plugins.min.json', 'plugins-desktop', true);
          updateUrls('.dist/plugins.json', 'plugins/plugins.json', 'plugins-android', false);
          updateUrls('.dist/plugins.min.json', 'plugins/plugins.min.json', 'plugins-android', true);
          SCRIPT
      
      - name: Generate READMEs
        run: |
          # Android README
          cat > plugins-android/README.md << 'EOF'
          # LNReader Plugins - Android (ES5)
          
          **ES5 compatible plugins for Android (Rhino JavaScript engine)**
          
          Built from: https://github.com/LNReader/lnreader-plugins
          
          All dependencies bundled, transpiled to ES5 for maximum compatibility.
          EOF
          
          # Desktop README
          cat > plugins-desktop/README.md << 'EOF'
          # LNReader Plugins - Desktop (Modern JS)
          
          **Modern JavaScript plugins for Desktop (GraalVM)**
          
          Built from: https://github.com/LNReader/lnreader-plugins
          
          All dependencies bundled, optimized for GraalVM.
          EOF
          
          # Main README
          cat > plugins/README.md << 'EOF'
          # Unminified LNReader Plugins
          
          Built from: https://github.com/LNReader/lnreader-plugins
          
          ## Available Versions
          
          - **plugins-android/** - ES5 compatible for Android (Rhino)
          - **plugins-desktop/** - Modern JS for Desktop (GraalVM)
          EOF
      
      - name: Commit to repo branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add plugins/ plugins-android/ plugins-desktop/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update plugins - $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin repo
            echo "âœ… Pushed to repo branch"
          fi
      
      - name: Package plugins
        run: |
          tar -czf android-plugins-es5.tar.gz plugins-android/
          tar -czf desktop-plugins-modern.tar.gz plugins-desktop/
          tar -czf all-plugins.tar.gz plugins/
          echo "âœ… Created plugin archives"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Bundled Plugins v${{ github.run_number }}
          body: |
            # LNReader Plugins - Bundled & Unminified
            
            Built from: https://github.com/LNReader/lnreader-plugins
            
            ## ðŸ“¥ Download
            
            - **android-plugins-es5.tar.gz** - ES5 for Android (Rhino)
            - **desktop-plugins-modern.tar.gz** - Modern JS for Desktop (GraalVM)
            - **all-plugins.tar.gz** - All plugins (Android version)
            
            ## âœ¨ Features
            - âœ… All dependencies bundled (cheerio, dayjs, etc.)
            - âœ… Non-minified for easy debugging
            - âœ… ES5 compatible for Android
            - âœ… Self-contained - no external modules needed
          files: |
            *.tar.gz
            plugins-android/plugins.json
            plugins-android/plugins.min.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
